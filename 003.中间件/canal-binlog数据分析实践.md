# canal - binlog 数据解析实践
## 场景
1. 可销售库存实时计算
    1. 业务端监控 库存,网店单据,进销存单据数量变更,进行汇总计算
    2. 从现有埋点方式 改为 数据库实时分析模式,避免功能变更遗漏库存计算
2. 网店运营统计 - 增量计算
    1. 监控数据变更,进行实时汇总
3. 其他...
   
### 同现有方案对比
#### 优点
1. 对开发人员简单 开发人员直接对接数据变更,避免对业务代码的污染
2. 实时性 binlog可以看做近实时方案,在性能上等于或由于现有方案
3. 准确性 相比于埋点的方式,准确性会答复提高,因为业务功能变更造成数据不准确的概率也会降低

#### 缺点
1. server 高可用带来的复杂配置,需要接入zk保证高可用,同一个instance至少需要2个
2. client 高可用方案?如果client不保证高可用,就会导致最终结果不准确
3. 额外的重算工具, 每个具体的场景都需要对应的重算工具来对结果纠正,对比差异
   
## 方案
### 架构
![架构图](images\canal-binlog数据分析实践\deploy.jpg)

### 关注点
1. 数据可靠性
    1. 解析点位和消费点位支持file和zk持久化,同时串行修改点位,保证读取和消费点位的准确性
    2. 通过 prometheus 接入现有 grafana 监控
    3. 原生支持 rabbitMQ,kafka,elasticsearch 等高性能存储,在binlog消费有性能瓶颈时,可以引入(后期优化)
2. 性能
    1. [官方](https://github.com/alibaba/canal/wiki/Performance)给出的性能瓶颈主要在于
        1. binlog event解析生成canal entry
        2. client - server 网络速度
        3. 内存大小 - 在批量dml的场景,Protobuf压缩可能会造成oom
    2. 产品binlog性能评估
        1. 目前d3main1 近18天 binlog size约等于20G,单台rds峰值最高不超过 1MB/s,分区最高峰值不超过 1MB/s*rds数量
        2. 官方性能测试,24core/96G,最低TPS 10W,42MB/s,因此一个canal server完全可以支持一个或多个分区
3. 高可用(后期优化)
    1. 原生支持zookeeper进行主备切换,[但是目前负载均衡实现方式不友好,只能水平扩展,人工指定负载](https://github.com/alibaba/canal/issues/147)
    2. 支持mysql主备切换,目前我们没有主备设置,所以不考虑
4. 历史数据
    1. rds 可以直接从 ali oss 拉取之前的binlog,只需要配置即可
    2. 本地 binlog 可以通过上传服务器,配置本地解析器即可
5. 安全
   1. RDS的passwork,ali oss ak,sk 可以通过RSA算法加解密
   2. 业务敏感数据安全性可以在client端依赖sis, 但是最好非必要情况不使用敏感数据
   3. canal server 和 client 的安全校验,可以自定义校验模块,通过user+passwrod方式建立可信连接

### 计划
1. canal server 改造
    1. grafana接入
    2. 安全性改造
2. canal client 
    1. sdk 开发
    2. client 基础框架开发
    3. client 技术选型?
        1. .net 对于zookeeper支持不好
        2. java 目前开发人员存在上手难度
3. 网店运营统计改造
    1. 基于 binlog 增量统计变更量
    2. 配套重算工具,每天重算帐套数据,对比差异,生成对比报告
4. 原有方案兼容,保证能够及时切换到原有方案 (帐套级别)
    1. 增加配置,给指定帐套开放功能

## 场景改造
### 网店运营统计
1. 模型分析
   - 当前业务模型  
     收集: 业务埋点 -> 构建发货单汇总数据 -> 推送redis -> tool 更新或删除 -> elasticsearch 存储
     展示: Web UI 汇总查询 -> elasticsearch
   - 采用 binlog 分析业务模型
     收集: mysql -> canal server -> 发货单分析client -> elasticsearch 存储
     展示: 与之前保持一致
     数据一致性: 通过重算工具定时重新计算发生过变更的订单,对比差异
2. 模型对比
    1. 当前模型
        * 数据在收集时进行汇总,存在业务逻辑变更,导致所有数据无效风险
        * 数据收集采用埋点方式,埋点位置,相关业务变更都会导致数据无效
        * 采用es查询,效率比以往mysql查询效率提升明显
    2. binlog模型
        * binlog方式无法采集之前历史数据,只能通过配套工具导入
        * 增量计算因为算法或工具等原因产生误差,需要配套重算工具达到最终一致性
        * 数据采用增量方式计算,能够精确到字段级别,计算效率会比汇总计算效率高
3. 计划
    1. 分析client
    2. 重算工具
    3. web报表查询修改

### 可销售库存
    业务模型和现有可销售库存模型基本一致  
    不过采用binlog方式可以完全取消业务埋点方式  
    在稳定之后,数据准确度和计算效率都会优于当前的新老方式

## 实施
### 测试环境
1. mysql
2. canal server
3. canal client
4. docker 

### 正式环境

### 参考
1. [canal源码解析](http://www.tianshouzhi.com/api/tutorials/canal/380)

## 计划及安排
### 进度
1. 工作事项
    - 调研当前可销售库存计算背景
    - canal server docker化
    - 可销售库存分析client
    - 可销售库存重算工具(支持多维度重算, 数据库/帐套/SKU)
    - web功能修改,兼容实时计算,埋点增量,binlog增量
### 预期结果
> 满足库存结果准确性99%,库存查询响应时间不超过1S
###实施阶段
1. 第一阶段,试点 5~10家可销售库存计算存在问题的客户.
2. 第二阶段,一个部署或分区上线
3. 第三阶段,全面上线
4. 第四阶段,优化其他可以利用该模型的场景
### 
